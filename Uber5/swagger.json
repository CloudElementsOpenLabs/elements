{"id":159,"name":"Sync Facebook Lead Ads to Sailthru","description":"Sync Facebook Lead Ad data to Sailthru","userId":149928,"accountId":149865,"createdDate":"2015-10-16T01:50:09Z","steps":[{"id":771,"onSuccess":["filterHasEmail"],"onFailure":[],"name":"constructUserPayload","type":"script","properties":{"mimeType":"application/javascript","body":"var lead = steps.getLeadId;\nvar leadgen = steps.getFacebookLead.response.body;\nvar form = steps.getFormDetails.response.body;\nvar fieldData = leadgen.field_data;\nvar email = \"\";\nvar body = {vars:{},lists:{}};\nvar webhook_type = trigger.event.objectType;\n\n// Add the user to a list called Facebook Lead Ads. \nbody.lists[\"facebook_lead_ads\"] = 1;\n\nif (lead.formId !== null) {\n    // form data \n   \n   //if (!form.message) {\n      body.vars.form_name = \"\"+form.name+\"\";\n      body.vars.facebook_lead_form_name = \"\"+form.name+\"\";\n      body.vars.facebook_form = form;\n   //} \n\n  body.vars.facebook_form_id = \"\"+lead.formId+\"\";\n\n} \n\n// temporary to make sure we keep the form name\nif (webhook_type == 'leadgen_fat') {\n  body.vars.facebook_lead_form_name = steps.loopLeads.entry.value.form_name;\n  body.vars.form_name = steps.loopLeads.entry.value.form_name;\n} \n\n\n//if (lead.leadgen.ad_id === 0 && lead.leadgen.page_id == \"273168189432248\") {   \n\t//body.vars.facebook_lead_type = \"CTA\";\n  //body.lists[\"facebook_cta\"] = 1;\n//} else {\n  //body.vars.facebook_lead_type = \"Lead Ad\";\n//}\n\nif (lead.leadgen.ad_id === 0 ) {   \n\tbody.vars.facebook_lead_type = \"CTA\";\n  body.lists[\"facebook_cta\"] = 1;\n} else {\n  body.vars.facebook_lead_type = \"Lead Ad\";\n}\n\nfieldData.forEach(function(data) {\n  if (data.name === 'email') {\n    email = data.values[0];\n  } else {\n    body.vars[data.name] = data.values.length === 1 ? data.values[0] : data.values;\n  }\n});\n\nbody.vars.facebook_leadgen_id = \"\"+leadgen.id+\"\";\n\n// This should always be set on a lead ad, but may not be present on a CTA\nif (lead.pageId) {\n// deprecate this in the future.\n  body.vars.page_id = \"\"+lead.pageId+\"\";\n  // in this update add another var to specifically call out the FB form name\n  body.vars.facebook_page_id = \"\"+lead.pageId+\"\";\n} \n\n// only set the var if it exists for each of the facebook lead ad Data .\nif (leadgen.ad_id) {\n  body.vars.facebook_ad_id = \"\"+leadgen.ad_id+\"\";\n}\n\nif (leadgen.adgroup_name) {\n  body.vars.facebook_adgroup_name = \"\"+leadgen.adgroup_name+\"\";\n}\n\nif (leadgen.adset_name) {\n  body.vars.facebook_adset_name = \"\"+leadgen.adset_name+\"\";\n}\n\nif (leadgen.adgroup_id) {\n  body.vars.facebook_adgroup_id = \"\"+leadgen.adgroup_id+\"\";\n}\n\nif (leadgen.campaign_name) {\n  body.vars.facebook_campaign_name = \"\"+leadgen.campaign_name+\"\";\n}\n\nif (leadgen.campaign_id) {\n  body.vars.facebook_campaign_id = \"\"+leadgen.campaign_id+\"\";\n}\n\nbody.vars.signup_time = leadgen.created_time;\nbody.vars.source = \"facebook\";\nbody.optout_email = \"none\";\n\nreturn {\n  email: email,\n  body: body\n}\n\n///// OLD \n\n// var leadgen = steps.loopLeads.entry.value;\n// var fieldData = leadgen.field_data;\n// var email = \"\";\n// var body = {vars:{},lists:{}};\n// fieldData.forEach(function(data) {\n//   if (data.name === 'email') {\n//     email = data.values[0];\n//   } else {\n//     body.vars[data.name] = data.values.length === 1 ? data.values[0] : data.values;\n//   }\n// });\n\n// body.vars.facebook_leadgen_id = \"\"+leadgen.leadgen_id+\"\";\n// body.vars.facebook_ad_id = \"\"+leadgen.ad_id+\"\";\n// body.vars.facebook_adgroup_name = \"\"+leadgen.adgroup_name+\"\";\n// body.vars.facebook_adset_name = \"\"+leadgen.adset_name+\"\";\n// body.vars.facebook_adgroup_id = \"\"+leadgen.adgroup_id+\"\";\n// body.vars.facebook_campaign_name = \"\"+leadgen.campaign_name+\"\";\n// body.vars.facebook_campaign_id = \"\"+leadgen.campaign_id+\"\";\n// body.vars.form_name = leadgen.form_name;\n// body.vars.facebook_lead_form_name = leadgen.form_name;\n// body.vars.page_id = \"\"+leadgen.page_id+\"\";\n// body.vars.signup_time = leadgen.created_time;\n// body.vars.source = \"facebook\";\n// body.optout_email = \"none\";\n\n// body.lists[\"facebook_lead_ads\"] = 1;\n\n// return {\n//   email: email,\n//   body: body\n// }","scriptEngine":"v1"}},{"id":51915,"onSuccess":["filterLeadAdsCTA"],"onFailure":[],"name":"getFacebookLead","type":"elementRequest","properties":{"elementInstanceId":"${config.facebookleadads.instance.id}","retryAttempts":"5","retryDelay":"750","api":"/hubs/marketing/leads/{leadId}?fields=campaign_id,campaign_name,adset_id,ad_name,created_time,form_id,field_data,id,is_organic,post,adset_name,ad_id,custom_disclaimer_responses,retailer_item_id","path":"${steps.getLeadId}","method":"GET","retry":"true"}},{"id":51916,"onSuccess":["constructUserPayload"],"onFailure":["constructUserPayload"],"name":"getFormDetails","type":"elementRequest","properties":{"elementInstanceId":"${config.facebookleadads.instance.id}","retryAttempts":"5","retryDelay":"750","api":"/hubs/marketing/pages/{form_id}?fields=id,name,creator,legal_content","path":"${steps.getLeadId.leadgen}","method":"GET","query":"${fields=id,name,creator,legal_content}","retry":"true"}},{"id":51930,"onSuccess":["getFormDetails"],"onFailure":["getFormDetails"],"name":"filterLeadAdsCTA","type":"filter","properties":{"body":"var lead = steps.getLeadId;\n\nif (lead.formId !== null) {\n return true;\n} else {\n   return false;\n}","scriptEngine":"v1"}},{"id":51928,"onSuccess":["SendEventToSailthru"],"onFailure":["loopLeads"],"name":"filterWebhookType","type":"filter","properties":{"body":"var t = trigger.event.objectType;\nif (t == 'leadgen') {\n  return true;\n} else {\n  return false;\n}","scriptEngine":"v1"}},{"id":4159,"onSuccess":["filterWebhookType"],"onFailure":[],"name":"CallEventApi","type":"script","properties":{"mimeType":"application/javascript","body":"\nreturn {    \n   \t\t\"event\" : \"facebook_lead_ad_conversion\",    \n   \t\t\"id\" : steps.constructUserPayload.email,\n   \t\t\"key\" : \"email\", \n   \t\t\"vars\" : steps.constructUserPayload.body.vars,\n   \t}","scriptEngine":"v1"}},{"id":776,"onSuccess":["getLeadId"],"onFailure":[],"name":"loopLeads","type":"loop","properties":{"mimeType":"application/javascript","list":"${trigger.body.message.raw.entry[0].changes}"}},{"id":51917,"onSuccess":["getFacebookLead"],"onFailure":[],"name":"getLeadId","type":"script","properties":{"body":"var leadgen = steps.loopLeads.entry.value;\nvar leadId = leadgen.leadgen_id;\n\nif (leadgen.form_id) {\n  id = leadgen.form_id;\n} else {\n  id = null;\n}\n\nif (leadgen.page_id) {\n  pid = leadgen.page_id;\n} else {\n  pid = null;\n}\n\nreturn {\n\tleadId : leadId,\n\tleadgen : leadgen,\n\tformId : id,\n\tpageId : pid,\n}","scriptEngine":"v1"}},{"id":770,"onSuccess":["createUser"],"onFailure":["loopLeads"],"name":"constructCreateUserPayload","type":"script","properties":{"mimeType":"application/javascript","body":"var email = steps.constructUserPayload.email;\nvar body = steps.constructUserPayload.body;\nbody.id = email;\nreturn body;","scriptEngine":"v1"}},{"id":3627,"onSuccess":["loopLeads"],"onFailure":[],"name":"filter-pageId","type":"filter","properties":{"mimeType":"application/javascript","body":"var leadgencheck = trigger.body.message.raw.entry[0].id;\n\nif (leadgencheck == config.pageid) {\n  return true;\n}\nelse {\n  return false;\n}","scriptEngine":"v1"}},{"id":777,"onSuccess":["CallEventApi"],"onFailure":["loopLeads"],"name":"updateUser","type":"elementRequest","properties":{"elementInstanceId":"${sailthru.instance.id}","mimeType":"application/javascript","body":"${steps.constructUserPayload.body}","path":"${steps.constructUserPayload}","api":"/hubs/marketing/users/{email}","method":"PATCH"}},{"id":3651,"onSuccess":["filter-pageId"],"onFailure":["getAllFormulaInstances"],"name":"does-pageId-exist","type":"filter","properties":{"mimeType":"application/javascript","body":"if (config.pageid) {\n  return true;\n}\nelse {\n  return false;\n}","scriptEngine":"v1"}},{"id":773,"onSuccess":["getUser"],"onFailure":["loopLeads"],"name":"filterHasEmail","type":"filter","properties":{"mimeType":"application/javascript","body":"var email = steps.constructUserPayload.email;\nreturn email != \"\";\n","scriptEngine":"v1"}},{"id":774,"onSuccess":["updateUser"],"onFailure":["constructCreateUserPayload"],"name":"filterUserExists","type":"filter","properties":{"mimeType":"application/javascript","body":"var user = steps.getUser.response.body;\nreturn steps.getUser.response.body.length > 0;","scriptEngine":"v1"}},{"id":3696,"onSuccess":["loopLeads"],"onFailure":["selfDestruct"],"name":"filterInstancesCount","type":"filter","properties":{"mimeType":"application/javascript","body":"var instances = Java.from(steps.getAllFormulaInstances.response.body);\nif (instances.length > 1) {\n  return false;\n} else {\n  return true;\n}\n","scriptEngine":"v1"}},{"id":3697,"onSuccess":[],"onFailure":[],"name":"selfDestruct","type":"request","properties":{"path":"${info}","api":"/formulas/{formulaId}/instances/{formulaInstanceId}","method":"DELETE"}},{"id":3695,"onSuccess":["filterInstancesCount"],"onFailure":[],"name":"getAllFormulaInstances","type":"request","properties":{"path":"${info}","api":"/formulas/{formulaId}/instances","method":"GET"}},{"id":772,"onSuccess":["CallEventApi"],"onFailure":["loopLeads"],"name":"createUser","type":"elementRequest","properties":{"elementInstanceId":"${sailthru.instance.id}","body":"${steps.constructCreateUserPayload}","api":"/hubs/marketing/users","method":"POST"}},{"id":4160,"onSuccess":["loopLeads"],"onFailure":["loopLeads"],"name":"SendEventToSailthru","type":"elementRequest","properties":{"elementInstanceId":"${sailthru.instance.id}","body":"${steps.CallEventApi}","api":"/hubs/marketing/trigger-events/fire","method":"POST"}},{"id":775,"onSuccess":["filterUserExists"],"onFailure":["loopLeads"],"name":"getUser","type":"elementRequest","properties":{"elementInstanceId":"${sailthru.instance.id}","path":"${steps.constructUserPayload}","api":"/hubs/marketing/users?where=email='{email}'","method":"GET"}}],"triggers":[{"id":104,"onSuccess":["does-pageId-exist"],"onFailure":[],"type":"event","async":true,"name":"trigger","properties":{"elementInstanceId":"${facebookleadads.instance.id}"}}],"active":true,"singleThreaded":false,"debugLoggingEnabled":true,"configuration":[{"id":115,"key":"facebookleadads.instance.id","name":"facebookleadadsInstance","type":"elementInstance","description":"The Facebook Lead Ads element instance","required":true},{"id":833,"key":"pageid","name":"pageId","type":"value","required":true},{"id":116,"key":"sailthru.instance.id","name":"sailthruInstance","type":"elementInstance","description":"The Sailthru marketing element instance","required":true}]}